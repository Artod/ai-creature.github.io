 <!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <title>Babylon.js sample code</title>

        <!-- Babylon.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
        <script src="https://preview.babylonjs.com/ammo.js"></script>
        <script src="https://preview.babylonjs.com/cannon.js"></script>
        <script src="https://preview.babylonjs.com/Oimo.js"></script>
        <script src="https://preview.babylonjs.com/earcut.min.js"></script>
        <script src="https://preview.babylonjs.com/babylon.js"></script>
        <script src="https://preview.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
        <script src="https://preview.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
        <script src="https://preview.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
        <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.js"></script>
        <script src="https://preview.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
        <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
        <script src="https://preview.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>

        <style>
            html, body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #renderCanvas {
                width: 100%;
                height: 100%;
                touch-action: none;
            }
        </style>
    </head>
<body>
    <canvas id="renderCanvas"></canvas>
    <script>
        var canvas = document.getElementById("renderCanvas");

        var engine = null;
        var scene = null;
        var sceneToRender = null;
        var createDefaultEngine = function() { 
            return new BABYLON.Engine(canvas, true, {
                preserveDrawingBuffer: true, 
                stencil: true,  
                disableWebGL2Support: false
            }); 
        };

        var createScene = async function () {
            // This creates a basic Babylon Scene object (non-mesh)
            var scene = new BABYLON.Scene(engine);
        
            // Environment
            var hdrTexture = BABYLON.CubeTexture.CreateFromPrefilteredData("3d/env/environment.dds", scene);
            hdrTexture.name = "envTex";
            hdrTexture.gammaSpace = false;
            scene.environmentTexture = hdrTexture;
        
            var skybox = BABYLON.MeshBuilder.CreateBox("skyBox", {size:1000.0}, scene);
            var skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
            skyboxMaterial.backFaceCulling = false;
            skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("3d/env/skybox", scene);
            skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
            skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
            skybox.material = skyboxMaterial;
        
            //CAMERA
            var camera = new BABYLON.ArcRotateCamera("Camera", BABYLON.Tools.ToRadians(-120), BABYLON.Tools.ToRadians(80), 65, new BABYLON.Vector3(0, -15, 0), scene);    
            camera.attachControl(canvas, true);
            camera.lowerRadiusLimit = 10;
            camera.upperRadiusLimit = 120;

            //enable Physics in the scene
            scene.enablePhysics(new BABYLON.Vector3(0, 0, 0), new BABYLON.AmmoJSPlugin());
        
            //LIGHTS
            var light1 = new BABYLON.PointLight("light1", new BABYLON.Vector3(0, 5,-6), scene);
            var light2 = new BABYLON.PointLight("light2", new BABYLON.Vector3(6, 5, 3.5), scene);
            var light3 = new BABYLON.DirectionalLight("light3", new BABYLON.Vector3(20, -5, 20), scene);
            light1.intensity = 15;
            light2.intensity = 5;
        

            engine.displayLoadingUI();


            await BABYLON.SceneLoader.AppendAsync("3d/marbleTower.glb");
            
            BABYLON.ParticleHelper.SnippetUrl = "3d/snippet";
            
            // CREATURE
            const creature = BABYLON.MeshBuilder.CreateSphere("creature", {diameter: 1, segments: 32}, scene);
            creature.isVisible = false;
            creature.setParent(null);
            
            // Sparks
            creature.sparks = await BABYLON.ParticleHelper.CreateFromSnippetAsync("UY098C-3.json", scene, false);
            creature.sparks.emitter = creature;
            
            // Core
            creature.glow = await BABYLON.ParticleHelper.CreateFromSnippetAsync("EXUQ7M-5.json", scene, false);
            // creature.glow2 = await BABYLON.ParticleHelper.CreateFromSnippetAsync("EXUQ7M-fast.json", scene, false);
            creature.glow.emitter = creature;

            engine.hideLoadingUI();


            // PHYSICS
            const rand = (min, max) => Math.random() * (max - min) + min;

            creature.impostor = new BABYLON.PhysicsImpostor(creature, BABYLON.PhysicsImpostor.SphereImpostor, {
                mass: 0.1
            }, scene);

            var tower = scene.getMeshByName("tower");
            tower.setParent(null);
            tower.impostor = new BABYLON.PhysicsImpostor(tower, BABYLON.PhysicsImpostor.MeshImpostor, {
                mass: 0,
                friction: 1
            });

            // ANIMATION
            setInterval(() => {
                const range = [-1, 1]
                var vec = new BABYLON.Vector3(rand(...range), rand(...range), rand(...range));

                creature.impostor.applyImpulse(vec, BABYLON.Vector3.Zero());
                
                //  creature.glow.color2 = new BABYLON.Color4(Math.random(), Math.random(), Math.random());
                const rotRange = [-2 * Math.PI, 2 * Math.PI]
                creature.addRotation(rand(...rotRange), rand(...rotRange), rand(...rotRange))
            }, 1000)

            scene.registerBeforeRender(() => {
                // creature.glow.worldOffset = creature.position
            });

            const cage = BABYLON.MeshBuilder.CreateBox("cage", {
                width: 35, 
                depth: 35, 
                height: 40
            }, scene);
            cage.position = new BABYLON.Vector3(0, -12,0);
            cage.isVisible = false;
            cage.setParent(null);

            cage.impostor = new BABYLON.PhysicsImpostor(cage, BABYLON.PhysicsImpostor.MeshImpostor, {
                mass: 0,
                friction: 1
            });

            return scene;
        };
        
        window.initFunction = async function() {
            await Ammo();
            
            var asyncEngineCreation = async function() {
                try {
                    return createDefaultEngine();
                } catch(e) {
                    console.log("the available createEngine function failed. Creating the default engine instead");
                    return createDefaultEngine();
                }
            }

            window.engine = await asyncEngineCreation();

            if (!engine) throw 'engine should not be null.';

            window.scene = await createScene();
        };

        initFunction().then(() => {
            sceneToRender = scene;
            engine.runRenderLoop(function () {
                if (sceneToRender && sceneToRender.activeCamera) {
                    sceneToRender.render();
                }
            });
        });

        // Resize
        window.addEventListener("resize", function () {
            engine.resize();
        });

    </script>
</body>
</html>
